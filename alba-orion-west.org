#+OPTIONS: ^:{}

* Dealing with the offset between image and spectrum
+ It seems that this is not as constant as I had hoped
  + In the [[id:8685D060-12A9-4E73-B069-11D5315ED8EB][vertical slits]] it varies from 52 to 60 pixels
  + And some slits do not have a reference star to use
+ One solution will be to compare the brightness profiles of the spectrum with that of the slit image
  + For the spectrum, we can sum in wavelength for the entire ha+nii range
  + For the image, we would sum a short width across the slit
+ Then we could either use the cross-correlation, or simple hunting, to find the best offset
+ At the same time, this would give the brightness factor between image and spec
  + We could use this to refine the brightness correction factors


** Application to the vertical slits
:PROPERTIES:
:dir:      ~/Dropbox/SPMJAN10/reducciones
:END:
#+name: vertical-image-and-fullspec
| image |    spec | islit | ishift |  fac |  bfac |
|-------+---------+-------+--------+------+-------|
|   202 | 203-204 | 233.6 |   52.5 |  3.9 | 1.029 |
|   124 | 125-127 | 235.5 |   54.5 | 2.45 | 1.143 |
|   206 | 207-208 | 234.6 |     54 |  4.4 | 1.021 |
|   133 | 134-135 | 239.4 |     58 |    5 | 1.206 |
|   210 | 211-212 | 236.4 |     55 |  4.4 | 1.003 |
|   137 | 138-139 | 241.3 |     60 |  2.8 | 1.122 |
|   214 | 215-216 | 238.4 |     55 |  4.1 | 1.010 |
|   248 | 249-250 | 254.9 |     68 | 5.85 | 1.330 |
|   219 | 220-221 | 240.0 |   57.5 | 4.35 | 1.011 |
|   236 | 237-238 | 247.0 |     63 |  4.2 | 1.037 |
|   240 | 241-242 | 249.5 |     65 |  3.1 |     1 |
|   244 | 245-246 | 251.6 |     64 |  2.7 | 1.065 |
|   252 | 253-254 | 258.2 |     69 |  5.4 | 1.198 |

+ Pixel positions of slits (islit in table above) also vary between positions, so I have had to measure all of these
  + They are FITS style 1-based indices
  + The slit width is about 4 pixels
  + But the slit center does not fall on an integer pixel
  + To be safe, we take the 5 pixels: [int(islit) - 3 : int(islit) + 3] 
+ First stab:
  + Read in the images and spectra, and overplot the profiles
  + There are 12 positions, so we can use a 4 x 3 grid
  + The =bfac= factors are the inter-position image brightness correction factors, calculated below - they multiply all the brightnesses
  + The =fac= factors are the image-to-spectrum brightness factors - they multiply the image profile so that it matches the spectrum profile
    + So larger factors mean better spectra (compared to what is expected from the image)
    + The most common factor /should/ correspond to equal conditions between image and spectrum. But in general =fac= could be larger or smaller than this.
    + I am assuing that =fac = 4.4= is the default value, and dividing all of them by this when I print the info on the plot
      + Interestingly for pos #248 we get fac of 1.33, which exactly cancels its value of bfac.  This means that the clouds that were there for the image had disappeared when te spectrum was taken!

#+header: :var table=vertical-image-and-fullspec
#+BEGIN_SRC python :return figfile :results file
  from astropy.io import fits
  import numpy as np
  import matplotlib.pyplot as plt
  import seaborn as sns

  nspec = 12
  ny = 512
  figfile = 'image-spec-offsets.pdf'
  yarray = np.arange(ny)
  fig, axgrid = plt.subplots(3, 5, sharex=True, sharey=True)

  for (imid, specid, islit, ishift, factor, bfac), ax in zip(table, axgrid.flat):
      imfile = 'posiciones/spm{}-ardec.fits'.format(imid)
      specfile = 'spm{}h.fits'.format(specid)
      islit = int(float(islit))
      ishift = float(ishift)
      factor = float(factor)
      bfac = float(bfac)

      imhdu, = fits.open(imfile)
      spechdu, = fits.open(specfile)

      imhdu.data -= 1170.0  # remove bias
      improfile = imhdu.data[:, islit-2:islit+2].sum(axis=1)
      specprofile = spechdu.data.sum(axis=1)

      ax.plot(yarray+ishift, bfac*factor*improfile/1e5, label='image', lw=2,
              alpha=0.3, c='r')
      ax.plot(yarray, bfac*specprofile/1e5, label='spectrum', lw=0.6, c='k')
   
      text = 'pos #{} shift = {:.1f} factor = {:.2f}'.format(imid, ishift, factor/4.4)
      ax.text(300, 0.1, text, ha='center', fontsize='xx-small')

  axgrid[0, 0].legend(fontsize='xx-small', loc='upper left')
  axgrid[0, 0].set_ylim(0.0, 2.1)
  axgrid[-1, 2].set_xlabel('pixel')
  axgrid[1, 0].set_ylabel('intensity')
  fig.suptitle('Alignment of vertical slits')
  fig.set_size_inches(11, 8.5)
  fig.savefig(figfile)


#+END_SRC

#+RESULTS:
[[file:/Users/will/Dropbox/SPMJAN10/reducciones/image-spec-offsets.pdf]]

* Datasets that we will use
** Dec 2014
** Dec 2013
** Feb 2013
** Jan 2010
:LOGBOOK:
CLOCK: [2015-08-16 Sun 18:29]--[2015-08-16 Sun 19:04] =>  0:35
:END:
+ Copied files to [[file:~/Dropbox/SPMJAN10/reducciones/][~/Dropbox/SPMJAN10/reducciones/]]
+ Looking at which ones to use to see if I agree with Tere
*** WCS values
+ Alba's coordinates seem to be for the center of the slit in the image+slit
+ dWav = 0.043752133846283 Ang (2 km/s)
+ dy = 

#+BEGIN_SRC python :return table :dir ~/Dropbox/SPMJAN10/reducciones/posiciones
import glob
import numpy as np
from astropy.io import fits
table = []
filenames = glob.glob('spm*-ardec.fits')
for fn in filenames:
    hdu, = fits.open(fn)
    dy = np.hypot(hdu.header['CD1_2'], hdu.header['CD2_2'])*3600
    table.append([fn, dy])
#+END_SRC

#+RESULTS:
|-------------------+--------------------|
| spm078-ardec.fits | 0.6220549447029587 |
| spm085-ardec.fits |   0.62317890413072 |
| spm101-ardec.fits | 0.6225012571392761 |
| spm124-ardec.fits |  0.622218813434036 |
| spm128-ardec.fits | 0.6231553370701498 |
| spm133-ardec.fits | 0.6231132792993379 |
| spm137-ardec.fits | 0.6231781063982743 |
| spm142-ardec.fits | 0.6213593488421689 |
| spm145-ardec.fits | 0.6217816676948823 |
| spm150-ardec.fits | 0.6230107112022361 |
| spm154-ardec.fits | 0.6238157549497414 |
| spm157-ardec.fits | 0.6210909967040036 |
| spm161-ardec.fits | 0.6211967486825171 |
| spm173-ardec.fits | 0.6217768871176305 |
| spm202-ardec.fits | 0.6246067241053639 |
| spm206-ardec.fits | 0.6227428493141918 |
| spm210-ardec.fits | 0.6229020762040736 |
| spm214-ardec.fits | 0.6247439611155685 |
| spm219-ardec.fits | 0.6227397401317721 |
| spm224-ardec.fits | 0.6232438303524672 |
| spm231-ardec.fits | 0.6226380945762506 |
| spm236-ardec.fits |  0.623354528585781 |
| spm240-ardec.fits | 0.6235692800557356 |
| spm244-ardec.fits | 0.6248870675138735 |
| spm248-ardec.fits | 0.6231268468158696 |
| spm252-ardec.fits | 0.6229126819583328 |
|-------------------+--------------------|
|                   |  0.6229 +/- 0.0002 |
#+TBLFM: @27$2=vmeane(@I..@II);f4

**** Offset along slit
:PROPERTIES:
:ID:       8685D060-12A9-4E73-B069-11D5315ED8EB
:END:
+ spm124
  + Star position is y = 270.5
  + Same star position in spec125-ha is y = 325
  + Shift of 325 - 270.5 = 54.5 pixels
+ spm137
  + Star position is y = 291
  + In spec138-ha it is y = 351
  + Shift of = 351 - 291 = 60

| spm124 | 270.5 | spec125 |   325 | 54.5 |
| spm202 |   359 | spec203 | 411.5 | 52.5 |
| spm206 |   104 | spec207 |   158 |   54 |
| spm137 |   291 | spec138 |   351 |   60 |
| spm219 | 320.5 | spec220 |   378 | 57.5 |
#+TBLFM: $5=$4 - $2

+ Unfortunately, the offset varies from spectrum to spectrum, which is odd  
*** Which to use
**** Positions in Alba's set that are acceptable
202, 124, 206, 133(+), 210, 137, 214, 248(+), 219, 236, 240, 244, 252

|  ID | Bright |  Norm | Inverse |
|-----+--------+-------+---------|
| 202 |   2087 | 0.972 |   1.029 |
| 124 |   1879 | 0.875 |   1.143 |
| 206 |   2101 | 0.979 |   1.021 |
| 133 |   1780 | 0.829 |   1.206 |
| 210 |   2141 | 0.997 |   1.003 |
| 137 |   1913 | 0.891 |   1.122 |
| 214 |   2125 | 0.990 |   1.010 |
| 248 |   1615 | 0.752 |   1.330 |
| 219 |   2124 | 0.989 |   1.011 |
| 236 |   2070 | 0.964 |   1.037 |
| 240 |   2147 |     1 |       1 |
| 244 |   2017 | 0.939 |   1.065 |
| 252 |   1792 | 0.835 |   1.198 |
#+TBLFM: $3=$-1/2147;f3::$4=1/$-1;f3

The Inverse column agrees closely with Alba's values 

**** Positions in Alba's set that are bad
128, 101, 145, 157, 173
**** Positions over to the NE
spm078, spm085
**** Other positions omitted ny Alba
+ spm142 - no spectrum
+ spm150 - ha spec exists, but looks weak and Tere says no
+ spm154 - no spectrum
+ spm161 - same as 150 but even worse
+ spm224 - has sii spec but no ha
+ spm231 - no spectrum
*** Message from Teresa [2010-02-18 Thu]
: Acabo de terminar las reducciones de las observaciones de Enero. Al
: final nos quedamos con 16 posiciones, eliminé 7 posiciones
: porque las observé con muchas nubes por lo que no obtuve buenos
: resultados, lo bueno fué que en la siguiente noche pude obtener
: estas posiciones o cercanas a ellas. De cualquier manera las reduje
: por si decidimos incluirlas.
: 
: Las reducciones estan en: /fs/tungol/home0/LEEDS/teresa/SPMENE10/reducciones
: 
: incluyo también la bitacora en pdf. Las posiciones que no tomé en
: cuenta para hacer los mapas fueron:
: 
: No incluidas        Slit cercana o casi en la misma posición que la anterior
: spm128                   spm133 (se ve mucho mejor que spm128)
: spm231                   spm248
: spm150                   spm224
: spm157                   spm236
: spm173                   spm252
: spm161
: spm129                   spm133
: 
: Hice la astrometría, las imagen+slit corregidas están en el directorio
: llamado "posiciones" adentro del direcotorio "reducciones"
: También hice dos posiciones al Este de la región observada. Están la
: oeste de HH 505, las observé en Halpha y [S II]:
: spm078 (image+slit), spm085 (image+slit). Podemos obtener la densidad
: en estas posiciones.
: 
: Para la posición de spm219 tomé los espectros en Ha (spm220,221),
: [SII] (spm225,226) y [OIII] (spm228,229)
: Los espectros corregidos en longitud de onda los puse en:
: 
: /fs/tungol/home0/LEEDS/teresa/SPMENE10/observaciones/SPM{ha,nii,siis,siil,oiii}
: 
: Después de hacer todo el trabajo hice el primer intento de los mapas
: de momentos de Halpha y [NII] :D a ver que te parecen,
: todos los archivos  estan en
: /fs/tungol/home0/LEEDS/teresa/SPMENE10/observaciones:
: 
: {ha,nii}_{-100-040,-060+000,+000+060,+060+140,-020+040).wisomom-sum-fake.fits
: 
: haciendo un smooth:
: 
: {ha,nii}_{-100-040,-060+000,+000+060,+060+140,-020+040).wisomom-sum-smooth2d.fits
: 
: Hice también en rangos de 20 km/s para poder hacer los mapas a color
: (no me quedarón también como a ti!)
: que son los que anexo a este email.

* Making spectral maps
+ The plan is to start with a fine orthogonal RA-dec grid
  + Place all the slits onto there by looping over slit pixels and painting all the grid pixels that fall in each
  + Leave grid pixels transparent where no slit falls
+ Then do the multi-resolution thing
  + As in [[id:E1B9B2C8-1CDE-407B-B9FE-4E31144F328C][Rebinning the maps]] in orion tsquared notes
  + Which makes use of [[file:~/Work/RubinWFC3/Tsquared/rebin_utils.py][file:~/Work/RubinWFC3/Tsquared/rebin_utils.py]]
+ This should give a map with all the holes filled in at lower resolution
+ To start with we will work with the original spectra that I already have
  + Later, we should switch to the bg-subtracted and brightness-corrected ones that Alba has
** Define the output grid
+ 1 arcsec is
  + 2.778e-4 deg declination
  + 2.765e-4 deg RA
+ We will try a grid with 1 arcsec pixels that is 512 x 512, which should fit in all of the slits
+ AR reference of the horizontal slits is 83.6158 +/- 0.0019
  + AR range of vertical slits is 83.6016 to 83.6205: 68 cos(-5.4150) = 67.7 arcsec
+ Dec reference of vertical slits is -5.4150 +/- 0.0006
  + Dec range of horizontal slits is -5.4409 to -5.4155 = 91.44 arcsec
+ So we use
  + CRPIX1 = CRPIX2 = 256.5
  + CRVAL1 = 83.6158, CRVAL2 = -5.4150
  + CDELT1 = 2.765e-4, CDELT2 = 2.778e-4
  + PC1_1 = -1.0, PC1_2 = 0.0
  + PC2_1 = 0.0, PC2_2 = 1.0

** Test with the velocity-integrated emission

#+BEGIN_SRC python :var vtab=vertical-slits :results output
for imname, specname, ra, dec, fac in vtab:
    print(specname)
#+END_SRC

#+RESULTS:
#+begin_example
spec253
spec174
spec245
spec241
spec237
spec158
spec220
spec249
spec146
spec215
spec138
spec211
spec102
spec129
spec134
spec207
spec125
spec203
#+end_example

* Coordinates of the slits
+ Data received from Alba [2015-08-11 Tue]

** Description from Alba
: Todos los datos están en:
: /fs/posgrado01/other0/albafm/WesternShocks/3.CuboWS/0.Datos
: Diferencio entre especros e imagenes y luego entre los del 2010 (verticales) y
: 2013 (horizontales)
: Todos los espectros tienen la sustraccion del continuo (*nc*) y los del 2010
: además tiene el factor de calidad (aplicado entre ellos y a todos los de esa
: campaña de observacion, son *cc*fits)
: 
: Por ultimo te adjunto tabla las coordenadas de cada posicion de las rendijas.



** Brightness correction factors
+ The 2010 data in =3.CuboWS/0.Datos= are =.nc.cc.= have already had this applied
+ The prior stage (just =.nc.=) is in =2.Datos2010/1.PreparandoDatos/1.SustraccionContinuo=
+ The factors are in [[file:/ssh:nil:/fs/posgrado01/other0/albafm/WesternShocks/2.Datos2010/1.PreparandoDatos/2.IgualandoCalidad/intensidades.dat][intensidades.dat]]
  + Transposed version of this table below
  + The factors multiply the observed intensities
+ The 2013 data don't seem to have any brightness correction

| Imagen | I. original | I. corregida |  Factor |
|--------+-------------+--------------+---------|
|    101 |     2149.52 |      2180.37 | 1.01435 |
|    124 |     1936.37 |      2180.37 | 1.12601 |
|    128 |     1567.50 |      2180.37 | 1.39099 |
|    133 |     1814.61 |      2180.37 | 1.20156 |
|    137 |     1939.18 |      2180.37 | 1.12438 |
|    145 |     1361.85 |      2180.37 | 1.60103 |
|    157 |     1323.03 |      2180.37 | 1.64801 |
|    173 |     1249.18 |      2180.37 | 1.74544 |
|    202 |     2170.67 |      2180.37 | 1.00447 |
|    206 |     2169.70 |      2180.37 | 1.00492 |
|    210 |     2211.48 |      2180.37 | 0.98594 |
|    214 |     2231.37 |      2180.37 | 0.97715 |
|    219 |     2226.34 |      2180.37 | 0.97935 |
|    236 |     2184.94 |      2180.37 | 0.99791 |
|    240 |     2186.48 |      2180.37 | 0.99720 |
|    244 |     2150.31 |      2180.37 | 1.01398 |
|    248 |     1632.71 |      2180.37 | 1.33543 |
|    252 |     1816.34 |      2180.37 | 1.20042 |

** HORIZONTALES 2013

#+name: horizontal-slits
| imagen | Espectro |                 AR |                DEC |
|--------+----------+--------------------+--------------------|
| spm165 | spec166  |            83.6141 |            -5.4409 |
| spm169 | spec170  |            83.6146 |            -5.4382 |
| spm237 | spec238  |            83.6166 |            -5.4361 |
| spm232 | spec233  |            83.6157 |            -5.4321 |
| spm226 | spec227  |            83.6076 |            -5.4294 |
| spm149 | spec150  |            83.6231 |            -5.4239 |
| spm154 | spec155  |            83.6237 |            -5.4226 |
| spm159 | spec160  |            83.6238 |            -5.4201 |
| spm033 | spec034  |            83.6107 |            -5.4165 |
| spm029 | spec030  |            83.6084 |            -5.4155 |
|--------+----------+--------------------+--------------------|
|        |          | 83.6158 +/- 0.0019 | -5.4275 +/- 0.0029 |
#+TBLFM: @12$3..@12$4=vmeane(@I..@II);f4

					
					
** VERTICALES 2010
+ From the region file [[file:/ssh:nil:/fs/posgrado01/other0/albafm/WesternShocks/3.CuboWS/1.Posiciones/pos_todas.reg][pos_todas.reg]] it looks like the PA = 3.03 deg

#+name: vertical-slits
| imagen | Espectro |                 AR |                DEC |  Factor |
|--------+----------+--------------------+--------------------+---------|
| spm252 | spec253  |            83.6016 |            -5.4149 | 1.20042 |
| spm173 | spec174  |            83.6020 |            -5.4108 | 1.74544 |
| spm244 | spec245  |            83.6031 |            -5.4152 | 1.01398 |
| spm240 | spec241  |            83.6053 |            -5.4153 | 0.99720 |
| spm236 | spec237  |            83.6071 |            -5.4155 | 0.99791 |
| spm157 | spec158  |            83.6078 |            -5.4118 | 1.64801 |
| spm219 | spec220  |            83.6087 |            -5.4163 | 0.97935 |
| spm248 | spec249  |            83.6091 |            -5.4150 | 1.33543 |
| spm145 | spec146  |            83.6106 |            -5.4109 | 1.60103 |
| spm214 | spec215  |            83.6119 |            -5.4160 | 0.97715 |
| spm137 | spec138  |            83.6133 |            -5.4120 | 1.12438 |
| spm210 | spec211  |            83.6143 |            -5.4163 | 0.98594 |
| spm101 | spec102  |            83.6149 |            -5.4177 | 1.01435 |
| spm128 | spec129  |            83.6156 |            -5.4181 | 1.39099 |
| spm133 | spec134  |            83.6159 |            -5.4123 | 1.20156 |
| spm206 | spec207  |            83.6171 |            -5.4165 | 1.00492 |
| spm124 | spec125  |            83.6184 |            -5.4183 | 1.12601 |
| spm202 | spec203  |            83.6205 |            -5.4167 | 1.00447 |
|--------+----------+--------------------+--------------------+---------|
|        |          | 83.6110 +/- 0.0014 | -5.4150 +/- 0.0006 |         |
#+TBLFM: @20$3..@20$4=vmeane(@I..@II);f4

